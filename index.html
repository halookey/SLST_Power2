<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>パワー指標計算アプリ</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    body {
      font-family: sans-serif;
      padding: 1em;
      max-width: 800px;
      margin: auto;
    }
    input, button, select {
      margin: 8px 0;
      padding: 0.7em;
      width: 100%;
      max-width: 100%;
      box-sizing: border-box;
      font-size: 1em;
    }
    label {
      display: block;
      margin-top: 10px;
      font-weight: bold;
    }
    .radio-group {
      display: flex;
      gap: 1em;
      margin-top: 5px;
    }
    .radio-group label {
      font-weight: normal;
    }
    button {
      font-size: 1em;
    }
    .result {
      margin-top: 1em;
      font-weight: bold;
    }
    .table-container {
      overflow-x: auto;
      margin-top: 1em;
    }
    table {
      border-collapse: collapse;
      width: 100%;
      min-width: 900px;
    }
    th, td {
      border: 1px solid #ccc;
      padding: 5px;
      text-align: center;
    }
    .actions button {
      margin: 2px;
      padding: 0.4em 0.8em;
      font-size: 0.9em;
    }
    @media (min-width: 768px) {
      input, button {
        width: 300px;
      }
    }
  </style>
</head>
<body>
  <h1>片脚立ち上がりパワー指標（W）計算＆CSV出力</h1>

  <label>測定日:</label>
  <input type="date" id="date">

  <label>参加者ID:</label>
  <input type="text" id="id">

  <label>測定側:</label>
  <div class="radio-group">
    <label><input type="radio" name="side" value="右脚" checked>右脚</label>
    <label><input type="radio" name="side" value="左脚">左脚</label>
  </div>

  <label>転子果長（cm）:</label>
  <input type="number" id="hipLength" step="0.1">

  <label>椅子の高さ（cm）:</label>
  <input type="number" id="chairHeight" step="0.1">

  <label>体重（kg）:</label>
  <input type="number" id="weight" step="0.1">

  <label>回数（回）:</label>
  <input type="number" id="reps">

  <label>所要時間（秒）:</label>
  <input type="number" id="time" step="0.1">

  <button onclick="addOrUpdateRecord()">計算して記録</button>
  <button onclick="downloadCSV()">CSVダウンロード</button>

  <div class="result" id="result"></div>

  <div class="table-container">
    <table id="dataTable">
      <thead>
        <tr>
          <th>日付</th><th>ID</th><th>測定側</th>
          <th>転子果長</th><th>椅子の高さ</th><th>体重</th>
          <th>回数</th><th>所要時間</th><th>パワー(W)</th><th>操作</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

  <script>
    let records = [];
    let editIndex = -1;

    window.onload = () => {
      const today = new Date().toISOString().split("T")[0];
      document.getElementById("date").value = today;
    };

    function addOrUpdateRecord() {
      const date = document.getElementById('date').value;
      const id = document.getElementById('id').value.trim();
      const side = document.querySelector('input[name="side"]:checked')?.value;
      const hipLength = parseFloat(document.getElementById('hipLength').value);
      const chairHeight = parseFloat(document.getElementById('chairHeight').value);
      const weight = parseFloat(document.getElementById('weight').value);
      const reps = parseFloat(document.getElementById('reps').value);
      const time = parseFloat(document.getElementById('time').value);

      if (!date || !id || !side || isNaN(hipLength) || isNaN(chairHeight) || isNaN(weight) || isNaN(reps) || isNaN(time) || time <= 0) {
        document.getElementById('result').textContent = 'すべての項目を正しく入力してください。';
        return;
      }

      const g = 9.8;
      const heightDiff = (hipLength - chairHeight) / 100;
      const power = (heightDiff * weight * g * reps) / time;
      const record = [date, id, side, hipLength, chairHeight, weight, reps, time, power.toFixed(2)];

      if (editIndex >= 0) {
        records[editIndex] = record;
        editIndex = -1;
        document.getElementById('result').textContent = `記録を更新しました。パワー指標: ${power.toFixed(2)} W`;
      } else {
        records.push(record);
        document.getElementById('result').textContent = `記録を追加しました。パワー指標: ${power.toFixed(2)} W`;
      }

      clearForm();
      renderTable();
    }

    function renderTable() {
      const tbody = document.querySelector("#dataTable tbody");
      tbody.innerHTML = "";
      records.forEach((row, index) => {
        const tr = document.createElement("tr");
        row.forEach(cell => {
          const td = document.createElement("td");
          td.textContent = cell;
          tr.appendChild(td);
        });

        const actionsTd = document.createElement("td");
        actionsTd.className = "actions";

        const editBtn = document.createElement("button");
        editBtn.textContent = "編集";
        editBtn.onclick = () => editRecord(index);

        const deleteBtn = document.createElement("button");
        deleteBtn.textContent = "削除";
        deleteBtn.onclick = () => deleteRecord(index);

        actionsTd.appendChild(editBtn);
        actionsTd.appendChild(deleteBtn);
        tr.appendChild(actionsTd);

        tbody.appendChild(tr);
      });
    }

    function editRecord(index) {
      const record = records[index];
      document.getElementById("date").value = record[0];
      document.getElementById("id").value = record[1];
      document.querySelector(`input[name="side"][value="${record[2]}"]`).checked = true;
      document.getElementById("hipLength").value = record[3];
      document.getElementById("chairHeight").value = record[4];
      document.getElementById("weight").value = record[5];
      document.getElementById("reps").value = record[6];
      document.getElementById("time").value = record[7];
      editIndex = index;
      document.getElementById('result').textContent = `編集中: ${record[1]} (${record[0]})`;
    }

    function deleteRecord(index) {
      if (confirm("この記録を削除しますか？")) {
        records.splice(index, 1);
        renderTable();
        document.getElementById('result').textContent = `記録を削除しました。`;
      }
    }

    function clearForm() {
      document.getElementById("id").value = "";
      document.getElementById("hipLength").value = "";
      document.getElementById("chairHeight").value = "";
      document.getElementById("weight").value = "";
      document.getElementById("reps").value = "";
      document.getElementById("time").value = "";
      document.querySelector('input[name="side"][value="右脚"]').checked = true;
    }

    function downloadCSV() {
      if (records.length === 0) {
        alert("データがありません。");
        return;
      }

      const header = ["日付", "ID", "測定側", "転子果長(cm)", "椅子の高さ(cm)", "体重(kg)", "回数", "所要時間(s)", "パワー(W)"];
      let csv = [header.join(",")];
      records.forEach(row => csv.push(row.join(",")));

      const bom = new Uint8Array([0xEF, 0xBB, 0xBF]);
      const blob = new Blob([bom, csv.join("\n")], { type: "text/csv;charset=utf-8;" });

      const date = new Date().toISOString().split("T")[0];
      const filename = `power_results_${date}.csv`;

      const url = URL.createObjectURL(blob);
      const link = document.createElement("a");
      link.href = url;
      link.download = filename;
      link.click();
    }
  </script>
</body>
</html>
